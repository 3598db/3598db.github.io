(window.webpackJsonp=window.webpackJsonp||[]).push([[132],{487:function(s,e,t){"use strict";t.r(e);var a=t(42),r=Object(a.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"模块入口文件优先级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#模块入口文件优先级"}},[s._v("#")]),s._v(" 模块入口文件优先级")]),s._v(" "),t("p",[s._v("文: @Weiyu-Chen")]),s._v(" "),t("p",[s._v("前端开发中使用到 "),t("code",[s._v("npm")]),s._v(" 包那可算是家常便饭，而使用到 "),t("code",[s._v("npm")]),s._v(" 包总免不了接触到 "),t("code",[s._v("package.json")]),s._v(" 包配置文件。")]),s._v(" "),t("p",[s._v("那么这里就有一个问题，当我们在不同环境下 "),t("code",[s._v("import")]),s._v(" 一个 "),t("code",[s._v("npm")]),s._v(" 包时，到底加载的是 "),t("code",[s._v("npm")]),s._v(" 包的哪个文件？")]),s._v(" "),t("p",[s._v("老司机们很快地给出答案："),t("strong",[t("code",[s._v("main")]),s._v(" 字段中指定的文件")]),s._v("。")]),s._v(" "),t("p",[s._v("然而我们清楚 "),t("code",[s._v("npm")]),s._v(" 包其实又分为：只允许在客户端使用的，只允许造服务端使用的，浏览器/服务端都可以使用。\n如果我们需要开发一个 "),t("code",[s._v("npm")]),s._v(" 包同时兼容支持 web端 和 server 端，"),t("strong",[s._v("需要在不同环境下加载npm包不同的入口文件")]),s._v("，显然一个 "),t("code",[s._v("main")]),s._v(" 字段已经不能够满足我们的需求，这就衍生出来了 "),t("code",[s._v("module")]),s._v(" 与 "),t("code",[s._v("browser")]),s._v(" 字段。")]),s._v(" "),t("p",[s._v("本文就来说下 这几个字段的使用场景，以及同时存在这几个字段时，他们之间的优先级。")]),s._v(" "),t("h1",{attrs:{id:"文件优先级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#文件优先级"}},[s._v("#")]),s._v(" 文件优先级")]),s._v(" "),t("p",[s._v("在说 "),t("code",[s._v("package.json")]),s._v(" 之前，先说下文件优先级")]),s._v(" "),t("p",[s._v("由于我们使用的模块规范有 ESM 和 commonJS 两种，为了能在 node 环境下原生执行 ESM 规范的脚本文件，"),t("code",[s._v(".mjs")]),s._v(" 文件就应运而生。")]),s._v(" "),t("p",[s._v("当存在 "),t("code",[s._v("index.mjs")]),s._v(" 和 "),t("code",[s._v("index.js")]),s._v(" 这种同名不同后缀的文件时，"),t("code",[s._v("import './index'")]),s._v(" 或者 "),t("code",[s._v("require('./index')")]),s._v(" 是会优先加载 "),t("code",[s._v("index.mjs")]),s._v(" 文件的。")]),s._v(" "),t("p",[s._v("也就是说，优先级 "),t("strong",[t("code",[s._v("mjs")]),s._v(" "),t("code",[s._v("js")])])]),s._v(" "),t("h1",{attrs:{id:"browser-module-和-main-字段"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#browser-module-和-main-字段"}},[s._v("#")]),s._v(" "),t("code",[s._v("browser")]),s._v("，"),t("code",[s._v("module")]),s._v(" 和 "),t("code",[s._v("main")]),s._v(" 字段")]),s._v(" "),t("h2",{attrs:{id:"字段定义"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#字段定义"}},[s._v("#")]),s._v(" 字段定义")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("main")]),s._v(" : 定义了 "),t("code",[s._v("npm")]),s._v(" 包的入口文件，browser 环境和 node 环境均可使用")]),s._v(" "),t("li",[t("code",[s._v("module")]),s._v(" : 定义 "),t("code",[s._v("npm")]),s._v(" 包的 ESM 规范的入口文件，browser 环境和 node 环境均可使用")]),s._v(" "),t("li",[s._v("·"),t("code",[s._v("browser")]),s._v(" : 定义 "),t("code",[s._v("npm")]),s._v(" 包在 browser 环境下的入口文件")])]),s._v(" "),t("h2",{attrs:{id:"使用场景与优先级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用场景与优先级"}},[s._v("#")]),s._v(" 使用场景与优先级")]),s._v(" "),t("p",[s._v("首先，我们假定 "),t("code",[s._v("npm")]),s._v(" 包 "),t("code",[s._v("test")]),s._v(" 有以下目录结构")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("----- lib\n   |-- index.browser.js\n   |-- index.browser.mjs\n   |-- index.js\n   |-- index.mjs\n")])])]),t("p",[s._v("其中 "),t("code",[s._v("*.js")]),s._v(" 文件是使用 commonJS 规范的语法("),t("code",[s._v("require('xxx')")]),s._v(")，"),t("code",[s._v("*.mjs")]),s._v(" 是用 ESM 规范的语法("),t("code",[s._v("import 'xxx'")]),s._v(")")]),s._v(" "),t("p",[s._v("其 package.json 文件：")]),s._v(" "),t("div",{staticClass:"language-json extra-class"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[s._v("  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"main"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lib/index.js"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// main ")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"module"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lib/index.mjs"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// module")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// browser 可定义成和 main/module 字段一一对应的映射对象，也可以直接定义为字符串")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"browser"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"./lib/index.js"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./lib/index.browser.js"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// browser+cjs")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"./lib/index.mjs"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./lib/index.browser.mjs"')]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// browser+mjs")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "browser": "./lib/index.browser.js" // browser')]),s._v("\n")])])]),t("p",[s._v("根据上述配置，那么其实我们的 "),t("code",[s._v("package.json")]),s._v(" 指定的入口可以有")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("main")])]),s._v(" "),t("li",[t("code",[s._v("module")])]),s._v(" "),t("li",[t("code",[s._v("browser")])]),s._v(" "),t("li",[t("code",[s._v("browser+cjs")])]),s._v(" "),t("li",[t("code",[s._v("browser+mjs")]),s._v("\n这 5 种情况。")])]),s._v(" "),t("p",[s._v("下面说下具体使用场景。")]),s._v(" "),t("h3",{attrs:{id:"webpack-web-esm"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#webpack-web-esm"}},[s._v("#")]),s._v(" webpack + web + ESM")]),s._v(" "),t("p",[s._v("这是我们最常见的使用场景，通过 "),t("code",[s._v("webpack")]),s._v(" 打包构建我们的 web 应用，模块语法使用 ESM")]),s._v(" "),t("p",[s._v("当我们加载")]),s._v(" "),t("div",{staticClass:"language-javascript extra-class"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" test "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test'")]),s._v("\n")])])]),t("p",[s._v("实际上的加载优先级是 "),t("strong",[t("code",[s._v("browser")]),s._v(" = "),t("code",[s._v("browser+mjs")]),s._v(" "),t("code",[s._v("module")]),s._v(" "),t("code",[s._v("browser+cjs")]),s._v(" "),t("code",[s._v("main")])]),s._v("\n也就是说 webpack 会根据这个顺序去寻找字段指定的文件，直到找到为止。")]),s._v(" "),t("p",[s._v("然而实际上的情况可能比这个更加复杂，具体可以参考流程图\n"),t("img",{attrs:{src:"https://user-images.githubusercontent.com/13402013/50725620-02d88e00-113b-11e9-8065-12fd12c6360a.png",alt:"image"}})]),s._v(" "),t("h3",{attrs:{id:"webpack-web-commonjs"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#webpack-web-commonjs"}},[s._v("#")]),s._v(" webpack + web + commonJS")]),s._v(" "),t("div",{staticClass:"language-javascript extra-class"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" test "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[s._v("事实上，构建 web 应用时，使用 "),t("code",[s._v("ESM")]),s._v(" 或者 "),t("code",[s._v("commonJS")]),s._v(" 模块规范对于加载优先级并没有任何影响")]),s._v(" "),t("p",[s._v("优先级依然是 "),t("strong",[t("code",[s._v("browser")]),s._v(" = "),t("code",[s._v("browser+mjs")]),s._v(" "),t("code",[s._v("module")]),s._v(" "),t("code",[s._v("browser+cjs")]),s._v(" "),t("code",[s._v("main")])])]),s._v(" "),t("h3",{attrs:{id:"webpack-node-esm-commonjs"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#webpack-node-esm-commonjs"}},[s._v("#")]),s._v(" webpack + node + ESM/commonJS")]),s._v(" "),t("p",[s._v("我们清楚，使用 webpack 构建项目的时候，有一个 "),t("a",{attrs:{href:"https://webpack.js.org/configuration/target/",target:"_blank",rel:"noopener noreferrer"}},[s._v("target"),t("OutboundLink")],1),s._v(" 选项，默认为 web，即进行 web 应用构建。")]),s._v(" "),t("p",[s._v("当我们需要进行一些 同构项目，或者其他 node 项目的构建的时候，我们需要将 "),t("code",[s._v("webpack.config.js")]),s._v(" 的 "),t("code",[s._v("target")]),s._v(" 选项设置为 "),t("code",[s._v("node")]),s._v(" 进行构建。")]),s._v(" "),t("div",{staticClass:"language-javascript extra-class"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" test "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 或者 const test = require('test')")]),s._v("\n")])])]),t("p",[s._v("优先级是： "),t("strong",[s._v("module main")])]),s._v(" "),t("h3",{attrs:{id:"node-commonjs"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#node-commonjs"}},[s._v("#")]),s._v(" node + commonJS")]),s._v(" "),t("p",[s._v("通过 "),t("code",[s._v("node test.js")]),s._v(" 直接执行脚本")]),s._v(" "),t("div",{staticClass:"language-javascript extra-class"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" test "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[t("strong",[s._v("只有 main 字段有效。")])]),s._v(" "),t("h3",{attrs:{id:"node-esm"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#node-esm"}},[s._v("#")]),s._v(" node + ESM")]),s._v(" "),t("p",[s._v("通过 "),t("code",[s._v("--experimental-modules")]),s._v(" 可以让 node 执行 ESM 规范的脚本(必须是 mjs 文件后缀)\n`node --experimental-modules test.mjs")]),s._v(" "),t("div",{staticClass:"language-javascript extra-class"},[t("pre",{pre:!0,attrs:{class:"language-javascript"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" test "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test'")]),s._v("\n")])])]),t("p",[t("strong",[s._v("只有 main 字段有效。")])]),s._v(" "),t("h1",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("ul",[t("li",[s._v("如果 "),t("code",[s._v("npm")]),s._v(" 包导出的是 ESM 规范的包，使用 module")]),s._v(" "),t("li",[s._v("如果 "),t("code",[s._v("npm")]),s._v(" 包只在 web 端使用，并且严禁在 server 端使用，使用 browser。")]),s._v(" "),t("li",[s._v("如果 "),t("code",[s._v("npm")]),s._v(" 包只在 server 端使用，使用 main")]),s._v(" "),t("li",[s._v("如果 "),t("code",[s._v("npm")]),s._v(" 包在 web 端和  server 端都允许使用，使用 browser 和 main")]),s._v(" "),t("li",[s._v("其他更加复杂的情况，如"),t("code",[s._v("npm")]),s._v(" 包需要提供 commonJS 与 ESM 等多个规范的代码文件，请参考上述使用场景或流程图")])])])}),[],!1,null,null,null);e.default=r.exports}}]);